<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KelionAI ‚Äî Trading Dashboard (Admin)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a1a;color:#e0e0e0;font-family:system-ui,sans-serif;min-height:100vh;padding-bottom:80px}
h1{color:#00ffff;font-size:1.4rem;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
.toolbar{display:flex;align-items:center;gap:12px;padding:12px 20px;background:rgba(255,255,255,.03)}
.auth-bar{display:flex;gap:8px;align-items:center;margin-left:auto}
input[type=password],input[type=text]{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:6px;padding:6px 10px;color:#e0e0e0;font-size:.85rem;width:200px}
input[type=text].symbol-input{width:140px}
button{background:#00ffff;color:#000;border:none;border-radius:6px;padding:6px 14px;cursor:pointer;font-weight:700;font-size:.85rem}
button.secondary{background:rgba(255,255,255,.1);color:#e0e0e0}
button.danger{background:#ff4444}
button:disabled{opacity:.5;cursor:not-allowed}
.tabs{display:flex;gap:0;padding:0 20px;border-bottom:1px solid rgba(255,255,255,.08);margin-top:16px}
.tab{padding:10px 18px;cursor:pointer;color:#888;border-bottom:2px solid transparent;font-size:.9rem;transition:color .2s,border-color .2s}
.tab.active{color:#00ffff;border-color:#00ffff}
.tab:hover:not(.active){color:#ccc}
.panel{display:none;padding:20px}
.panel.active{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-bottom:20px}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:16px}
.card h3{font-size:.8rem;text-transform:uppercase;color:#666;letter-spacing:.8px;margin-bottom:10px}
.symbol{font-size:1.1rem;font-weight:700;color:#e0e0e0}
.name{font-size:.8rem;color:#888;margin-bottom:6px}
.price{font-size:1.4rem;font-weight:bold;color:#00ffff}
.change{font-size:.9rem;font-weight:600;margin-left:8px}
.change.up{color:#00ff88}
.change.down{color:#ff4444}
.meta{font-size:.75rem;color:#666;margin-top:6px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{color:#666;text-align:left;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:.75rem;text-transform:uppercase;letter-spacing:.6px}
td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.04)}
tr:hover td{background:rgba(255,255,255,.03)}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.75rem;font-weight:700}
.badge.bullish{background:rgba(0,255,136,.15);color:#00ff88}
.badge.bearish{background:rgba(255,68,68,.15);color:#ff4444}
.badge.neutral{background:rgba(255,255,255,.1);color:#aaa}
.badge.buy{background:rgba(0,255,136,.2);color:#00ff88}
.badge.sell{background:rgba(255,68,68,.2);color:#ff4444}
.badge.hold{background:rgba(255,170,0,.15);color:#ffaa00}
.analysis-box{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:20px;margin-top:16px}
.analysis-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.analysis-row:last-child{border:none}
.analysis-label{color:#888;font-size:.85rem}
.analysis-value{font-weight:700}
.watchlist{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:16px}
.wl-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.wl-item:last-child{border:none}
.wl-sym{font-weight:700;color:#00ffff}
.news-item{padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)}
.news-item:last-child{border:none}
.news-title{font-size:.9rem;color:#e0e0e0;margin-bottom:4px}
.news-title a{color:#00ffff;text-decoration:none}
.news-title a:hover{text-decoration:underline}
.news-meta{font-size:.75rem;color:#666}
.news-desc{font-size:.8rem;color:#999;margin-top:4px}
.disclaimer-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(255,170,0,.12);border-top:1px solid rgba(255,170,0,.3);color:#ffaa00;font-size:.78rem;padding:8px 20px;text-align:center;z-index:100}
.loading{color:#666;font-style:italic;padding:20px 0}
.error-msg{color:#ff4444;font-size:.85rem;padding:8px}
.add-wl{display:flex;gap:8px;margin-bottom:12px}
.rsi-bar{height:8px;background:rgba(255,255,255,.1);border-radius:4px;margin-top:4px;position:relative}
.rsi-fill{height:100%;border-radius:4px;transition:width .4s}
.refresh-info{font-size:.75rem;color:#555;margin-left:8px}
#search-panel .row-wrap{display:flex;gap:16px;flex-wrap:wrap}
#search-panel .col-main{flex:2;min-width:260px}
#search-panel .col-side{flex:1;min-width:220px}
</style>
</head>
<body>

<h1>üìä KelionAI ‚Äî Trading Dashboard <span style="font-size:.75rem;color:#666;font-weight:normal">(ADMIN ONLY)</span></h1>

<div class="toolbar">
  <span style="font-size:.85rem;color:#888">Admin Secret:</span>
  <input type="password" id="admin-key" placeholder="x-admin-secret" value="">
  <button onclick="loadAll()">Connect</button>
  <span id="conn-status" style="font-size:.8rem;color:#666"></span>
  <span class="refresh-info" id="refresh-info"></span>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('crypto')">ü™ô Crypto</div>
  <div class="tab" onclick="switchTab('forex')">üí± Forex</div>
  <div class="tab" onclick="switchTab('analysis')">üìà Analysis</div>
  <div class="tab" onclick="switchTab('watchlist')">üëÅ Watchlist</div>
  <div class="tab" onclick="switchTab('news')">üì∞ News</div>
</div>

<!-- CRYPTO TAB -->
<div class="panel active" id="tab-crypto">
  <div id="crypto-grid" class="grid"><p class="loading">Loading crypto data‚Ä¶</p></div>
</div>

<!-- FOREX TAB -->
<div class="panel" id="tab-forex">
  <div id="forex-table"><p class="loading">Loading forex data‚Ä¶</p></div>
</div>

<!-- ANALYSIS TAB -->
<div class="panel" id="tab-analysis">
  <div style="display:flex;gap:8px;margin-bottom:16px">
    <input type="text" class="symbol-input" id="sym-input" placeholder="e.g. bitcoin, AAPL, EUR" value="">
    <button onclick="runAnalysis()">Analyze</button>
    <button class="secondary" onclick="addToWatchlistFromAnalysis()">+ Watchlist</button>
  </div>
  <div id="analysis-result"></div>
</div>

<!-- WATCHLIST TAB -->
<div class="panel" id="tab-watchlist">
  <div class="add-wl">
    <input type="text" class="symbol-input" id="wl-input" placeholder="Symbol to add" value="">
    <button onclick="addSymbol()">Add</button>
  </div>
  <div id="watchlist-content" class="watchlist"><p class="loading">Loading watchlist‚Ä¶</p></div>
</div>

<!-- NEWS TAB -->
<div class="panel" id="tab-news">
  <div id="news-list"><p class="loading">Loading market news‚Ä¶</p></div>
</div>

<!-- DISCLAIMER BAR -->
<div class="disclaimer-bar" id="disclaimer-bar">
  ‚ö†Ô∏è DISCLAIMER: Informational analysis only. NOT financial advice. Past performance does not guarantee future results. Always consult a licensed financial advisor. KelionAI never executes trades.
</div>

<script>
'use strict';

let adminKey = '';
let refreshTimer = null;
const REFRESH_INTERVAL = 2 * 60 * 1000; // 2 minutes

function getKey() {
  adminKey = document.getElementById('admin-key').value.trim();
  return adminKey;
}

function headers() {
  return { 'x-admin-secret': getKey(), 'Content-Type': 'application/json' };
}

async function apiFetch(path) {
  const r = await fetch(path, { headers: headers() });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function fmtNum(n, decimals = 2) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  return Number(n).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function fmtBig(n) {
  if (!n) return '‚Äî';
  if (n >= 1e12) return '$' + (n / 1e12).toFixed(2) + 'T';
  if (n >= 1e9)  return '$' + (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6)  return '$' + (n / 1e6).toFixed(2) + 'M';
  return '$' + fmtNum(n);
}

function changeHtml(pct) {
  if (pct === null || pct === undefined) return '';
  const cls = pct >= 0 ? 'up' : 'down';
  const sign = pct >= 0 ? '+' : '';
  return `<span class="change ${cls}">${sign}${fmtNum(pct)}%</span>`;
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(name, event) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.currentTarget.classList.add('active');
  if (name === 'news') loadNews();
  if (name === 'watchlist') loadWatchlist();
  if (name === 'forex') loadForex();
}

// ‚îÄ‚îÄ CRYPTO ‚îÄ‚îÄ
async function loadCrypto() {
  const el = document.getElementById('crypto-grid');
  try {
    const data = await apiFetch('/api/trading/crypto');
    if (!data.coins || data.coins.length === 0) { el.innerHTML = '<p class="error-msg">No crypto data available.</p>'; return; }
    el.innerHTML = data.coins.map(c => `
      <div class="card">
        <div class="symbol">${c.symbol}</div>
        <div class="name">${c.name}</div>
        <div>
          <span class="price">$${fmtNum(c.price, c.price < 1 ? 6 : 2)}</span>
          ${changeHtml(c.change24h)}
        </div>
        <div class="meta">
          MCap: ${fmtBig(c.marketCap)} &nbsp; Vol: ${fmtBig(c.volume24h)}<br>
          <span style="color:#444;font-size:.7rem">${c.dataSource || ''}</span>
        </div>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = `<p class="error-msg">Failed to load crypto: ${e.message}. Check admin key.</p>`;
  }
}

// ‚îÄ‚îÄ FOREX ‚îÄ‚îÄ
async function loadForex() {
  const el = document.getElementById('forex-table');
  try {
    const data = await apiFetch('/api/trading/forex');
    if (!data.pairs || data.pairs.length === 0) { el.innerHTML = '<p class="error-msg">No forex data available.</p>'; return; }
    el.innerHTML = `
      <table>
        <tr><th>Pair</th><th>Rate (vs 1 USD)</th><th>Source</th></tr>
        ${data.pairs.map(p => `
        <tr>
          <td><strong>${p.pair}</strong></td>
          <td>${fmtNum(p.rate, 4)}</td>
          <td style="color:#555;font-size:.75rem">${p.dataSource || ''}</td>
        </tr>`).join('')}
      </table>
      <p style="font-size:.72rem;color:#444;margin-top:8px">Fetched: ${data.fetchedAt}</p>`;
  } catch(e) {
    el.innerHTML = `<p class="error-msg">Failed to load forex: ${e.message}</p>`;
  }
}

// ‚îÄ‚îÄ ANALYSIS ‚îÄ‚îÄ
async function runAnalysis() {
  const sym = document.getElementById('sym-input').value.trim();
  if (!sym) return;
  const el = document.getElementById('analysis-result');
  el.innerHTML = '<p class="loading">Fetching analysis‚Ä¶</p>';
  try {
    const d = await apiFetch(`/api/trading/analysis/${encodeURIComponent(sym)}`);
    const a = d.analysis || {};
    const trendBadge = `<span class="badge ${a.trend || 'neutral'}">${(a.trend || 'N/A').toUpperCase()}</span>`;
    const sigBadge = a.signal ? `<span class="badge ${a.signal.toLowerCase()}">${a.signal}</span>` : '‚Äî';
    const rsiColor = a.rsi14 < 30 ? '#00ff88' : a.rsi14 > 70 ? '#ff4444' : '#00ffff';
    const rsiWidth = a.rsi14 !== null ? Math.min(100, a.rsi14) : 0;
    el.innerHTML = `
      <div class="analysis-box">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <div>
            <div class="symbol" style="font-size:1.3rem">${d.symbol}</div>
            <div class="name">${d.name}</div>
          </div>
          <div style="text-align:right">
            <div class="price" style="font-size:1.6rem">$${fmtNum(d.price, d.price && d.price < 1 ? 6 : 2)}</div>
            ${changeHtml(d.change24h)}
          </div>
        </div>
        <div class="analysis-row"><span class="analysis-label">SMA 20</span><span class="analysis-value">$${fmtNum(a.sma20, 2)}</span></div>
        <div class="analysis-row">
          <span class="analysis-label">RSI 14</span>
          <div style="text-align:right">
            <span class="analysis-value" style="color:${rsiColor}">${a.rsi14 !== null ? a.rsi14 : '‚Äî'}</span>
            <div class="rsi-bar" style="width:120px;display:inline-block;vertical-align:middle;margin-left:8px">
              <div class="rsi-fill" style="width:${rsiWidth}%;background:${rsiColor}"></div>
            </div>
          </div>
        </div>
        <div class="analysis-row"><span class="analysis-label">Trend</span>${trendBadge}</div>
        <div class="analysis-row"><span class="analysis-label">Signal</span>${sigBadge} <span style="color:#555;font-size:.75rem;margin-left:6px">confidence: ${a.confidence || '‚Äî'}</span></div>
        <div class="analysis-row"><span class="analysis-label">Market Cap</span><span class="analysis-value">${fmtBig(d.marketCap)}</span></div>
        <div class="analysis-row"><span class="analysis-label">Volume 24h</span><span class="analysis-value">${fmtBig(d.volume24h)}</span></div>
        <div class="analysis-row"><span class="analysis-label">Data Source</span><span style="color:#555">${d.dataSource}</span></div>
        <div style="margin-top:12px;font-size:.75rem;color:#aa8800;background:rgba(255,170,0,.07);border-radius:6px;padding:8px">${d.disclaimer}</div>
      </div>`;
  } catch(e) {
    el.innerHTML = `<p class="error-msg">Analysis failed: ${e.message}</p>`;
  }
}

function addToWatchlistFromAnalysis() {
  const sym = document.getElementById('sym-input').value.trim();
  if (sym) { document.getElementById('wl-input').value = sym; addSymbol(); }
}

// ‚îÄ‚îÄ WATCHLIST ‚îÄ‚îÄ
async function loadWatchlist() {
  const el = document.getElementById('watchlist-content');
  try {
    const data = await apiFetch('/api/trading/watchlist');
    if (!data.watchlist || data.watchlist.length === 0) {
      el.innerHTML = '<p style="color:#666;font-size:.85rem">No symbols in watchlist. Add some above.</p>'; return;
    }
    el.innerHTML = data.watchlist.map(sym => `
      <div class="wl-item">
        <span class="wl-sym">${sym}</span>
        <button class="danger" style="padding:3px 10px;font-size:.75rem" onclick="removeSymbol('${sym}')">Remove</button>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = `<p class="error-msg">Failed: ${e.message}</p>`;
  }
}

async function addSymbol() {
  const sym = document.getElementById('wl-input').value.trim();
  if (!sym) return;
  try {
    await fetch('/api/trading/watchlist', {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ symbol: sym, action: 'add' })
    });
    document.getElementById('wl-input').value = '';
    loadWatchlist();
  } catch(e) { alert('Error: ' + e.message); }
}

async function removeSymbol(sym) {
  try {
    await fetch('/api/trading/watchlist', {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({ symbol: sym, action: 'remove' })
    });
    loadWatchlist();
  } catch(e) { alert('Error: ' + e.message); }
}

// ‚îÄ‚îÄ NEWS ‚îÄ‚îÄ
async function loadNews() {
  const el = document.getElementById('news-list');
  try {
    const data = await apiFetch('/api/trading/news');
    if (!data.articles || data.articles.length === 0) {
      el.innerHTML = '<p class="error-msg">No news available at this time.</p>'; return;
    }
    el.innerHTML = data.articles.map(a => `
      <div class="news-item">
        <div class="news-title">
          ${a.link ? `<a href="${a.link}" target="_blank" rel="noopener noreferrer">${a.title}</a>` : a.title}
        </div>
        ${a.description ? `<div class="news-desc">${a.description}‚Ä¶</div>` : ''}
        <div class="news-meta">${a.pubDate || ''}</div>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = `<p class="error-msg">Failed to load news: ${e.message}</p>`;
  }
}

// ‚îÄ‚îÄ LOAD ALL & AUTO-REFRESH ‚îÄ‚îÄ
async function loadAll() {
  const status = document.getElementById('conn-status');
  status.textContent = 'Connecting‚Ä¶';
  status.style.color = '#ffaa00';
  try {
    await apiFetch('/api/trading/markets');
    status.textContent = '‚úÖ Connected';
    status.style.color = '#00ff88';
  } catch(e) {
    status.textContent = '‚ùå Auth failed ‚Äî check key';
    status.style.color = '#ff4444';
    return;
  }

  loadCrypto();
  loadNews();

  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(() => {
    loadCrypto();
    const activeTab = document.querySelector('.tab.active');
    if (activeTab) {
      const label = activeTab.textContent.trim().toLowerCase();
      if (label.includes('forex')) loadForex();
      if (label.includes('news')) loadNews();
      if (label.includes('watch')) loadWatchlist();
    }
    document.getElementById('refresh-info').textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
  }, REFRESH_INTERVAL);
  document.getElementById('refresh-info').textContent = 'Auto-refresh every 2 min';
}

// Allow Enter key in symbol input
document.getElementById('sym-input').addEventListener('keydown', e => { if (e.key === 'Enter') runAnalysis(); });
document.getElementById('wl-input').addEventListener('keydown', e => { if (e.key === 'Enter') addSymbol(); });
document.getElementById('admin-key').addEventListener('keydown', e => { if (e.key === 'Enter') loadAll(); });
</script>
</body>
</html>
