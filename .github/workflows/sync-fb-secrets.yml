name: ðŸ”‘ Sync FB Messenger Secrets

on:
  workflow_dispatch:
    inputs:
      fb_page_access_token:
        description: 'FB_PAGE_ACCESS_TOKEN (din developers.facebook.com â†’ Messenger â†’ Settings)'
        required: true
        type: string
      fb_app_secret:
        description: 'FB_APP_SECRET (din Facebook App â†’ Settings â†’ Basic)'
        required: true
        type: string
      fb_verify_token:
        description: 'FB_VERIFY_TOKEN (orice string aleatoriu)'
        required: false
        default: 'kelion-messenger-2026'
        type: string

permissions: {}

jobs:
  sync-to-railway:
    name: ðŸš‚ Sync to Railway
    runs-on: ubuntu-latest
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Set FB secrets in Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          FB_PAGE_ACCESS_TOKEN: ${{ github.event.inputs.fb_page_access_token }}
          FB_APP_SECRET: ${{ github.event.inputs.fb_app_secret }}
          FB_VERIFY_TOKEN: ${{ github.event.inputs.fb_verify_token }}
        run: |
          railway variables set FB_PAGE_ACCESS_TOKEN="$FB_PAGE_ACCESS_TOKEN" --service kelionai-v2
          railway variables set FB_APP_SECRET="$FB_APP_SECRET" --service kelionai-v2
          railway variables set FB_VERIFY_TOKEN="$FB_VERIFY_TOKEN" --service kelionai-v2
          echo "âœ… Railway: FB secrets set!"

  sync-to-netlify:
    name: ðŸŒ Sync to Netlify
    runs-on: ubuntu-latest
    steps:
      - name: Set FB secrets in Netlify env
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ github.event.inputs.fb_page_access_token }}
          FB_APP_SECRET: ${{ github.event.inputs.fb_app_secret }}
          FB_VERIFY_TOKEN: ${{ github.event.inputs.fb_verify_token }}
        run: |
          curl -s -X POST "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/env" \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"FB_PAGE_ACCESS_TOKEN\",
              \"values\": [{\"value\": \"${FB_PAGE_ACCESS_TOKEN}\", \"context\": \"production\"}]
            }"
          curl -s -X POST "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/env" \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"FB_APP_SECRET\",
              \"values\": [{\"value\": \"${FB_APP_SECRET}\", \"context\": \"production\"}]
            }"
          curl -s -X POST "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/env" \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"key\": \"FB_VERIFY_TOKEN\",
              \"values\": [{\"value\": \"${FB_VERIFY_TOKEN}\", \"context\": \"production\"}]
            }"
          echo "âœ… Netlify: FB secrets set!"

  sync-to-supabase:
    name: ðŸ—„ï¸ Sync to Supabase (app_config table)
    runs-on: ubuntu-latest
    steps:
      - name: Store FB config in Supabase app_config table
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          FB_PAGE_ACCESS_TOKEN: ${{ github.event.inputs.fb_page_access_token }}
          FB_APP_SECRET: ${{ github.event.inputs.fb_app_secret }}
          FB_VERIFY_TOKEN: ${{ github.event.inputs.fb_verify_token }}
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          curl -s -X POST "${SUPABASE_URL}/rest/v1/app_config" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "[
              {\"key\": \"FB_PAGE_ACCESS_TOKEN\", \"value\": \"${FB_PAGE_ACCESS_TOKEN}\", \"updated_at\": \"${NOW}\"},
              {\"key\": \"FB_APP_SECRET\", \"value\": \"${FB_APP_SECRET}\", \"updated_at\": \"${NOW}\"},
              {\"key\": \"FB_VERIFY_TOKEN\", \"value\": \"${FB_VERIFY_TOKEN}\", \"updated_at\": \"${NOW}\"}
            ]"
          echo "âœ… Supabase: FB config stored!"

  test-webhook:
    name: ðŸ§ª Test FB Webhook
    runs-on: ubuntu-latest
    needs: [sync-to-railway]
    steps:
      - name: Wait for Railway to redeploy
        run: sleep 30

      - name: Test webhook endpoint
        env:
          FB_VERIFY_TOKEN: ${{ github.event.inputs.fb_verify_token }}
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://kelionai-backend.railway.app/api/messenger/webhook?hub.mode=subscribe&hub.verify_token=${FB_VERIFY_TOKEN}&hub.challenge=test123")
          echo "Webhook response: $RESPONSE"
          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Webhook functional! Facebook Messenger e gata!"
          else
            echo "âš ï¸ Webhook response: $RESPONSE â€” verificÄƒ Railway deployment"
          fi

  summary:
    name: ðŸ“‹ Summary
    runs-on: ubuntu-latest
    needs: [sync-to-railway, sync-to-netlify, sync-to-supabase, test-webhook]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "## ðŸ”‘ FB Messenger Secrets Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš‚ Railway | ${{ needs.sync-to-railway.result }}" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Netlify | ${{ needs.sync-to-netlify.result }}" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ Supabase | ${{ needs.sync-to-supabase.result }}" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Webhook Test | ${{ needs.test-webhook.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Webhook URL pentru Facebook:**" >> $GITHUB_STEP_SUMMARY
          echo "\`https://kelionai-backend.railway.app/api/messenger/webhook\`" >> $GITHUB_STEP_SUMMARY
