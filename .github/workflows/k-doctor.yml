name: K-Doctor Auto-Repair

on:
  # Triggered by Sentry webhook via Netlify function
  repository_dispatch:
    types: [sentry-error]
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      error_message:
        description: 'Error message to fix'
        required: true
      error_file:
        description: 'File path with error'
        required: true
      error_line:
        description: 'Line number'
        required: false

concurrency:
  group: k-doctor
  cancel-in-progress: false

jobs:
  auto-repair:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Parse error details
        id: parse
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "error_message=${{ github.event.client_payload.error_message }}" >> $GITHUB_OUTPUT
            echo "error_file=${{ github.event.client_payload.error_file }}" >> $GITHUB_OUTPUT
            echo "error_line=${{ github.event.client_payload.error_line }}" >> $GITHUB_OUTPUT
            echo "sentry_url=${{ github.event.client_payload.sentry_url }}" >> $GITHUB_OUTPUT
          else
            echo "error_message=${{ github.event.inputs.error_message }}" >> $GITHUB_OUTPUT
            echo "error_file=${{ github.event.inputs.error_file }}" >> $GITHUB_OUTPUT
            echo "error_line=${{ github.event.inputs.error_line }}" >> $GITHUB_OUTPUT
            echo "sentry_url=manual" >> $GITHUB_OUTPUT
          fi

      - name: Read source file
        id: source
        run: |
          FILE="${{ steps.parse.outputs.error_file }}"
          if [ -f "$FILE" ]; then
            # Get file content (max 200 lines around error)
            CONTENT=$(cat "$FILE" | head -300)
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "$CONTENT" > /tmp/source_code.txt
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "File not found: $FILE"
          fi

      - name: Claude generates fix
        id: claude_fix
        if: steps.source.outputs.file_exists == 'true'
        run: |
          SOURCE=$(cat /tmp/source_code.txt)

          PROMPT="You are K-Doctor, an automated code repair AI.

          ERROR: ${{ steps.parse.outputs.error_message }}
          FILE: ${{ steps.parse.outputs.error_file }}
          LINE: ${{ steps.parse.outputs.error_line }}

          SOURCE CODE:
          $SOURCE

          INSTRUCTIONS:
          1. Analyze the error and the source code
          2. Generate ONLY the minimal fix needed
          3. Return EXACTLY this JSON format:
          {
            \"can_fix\": true/false,
            \"confidence\": 0.0-1.0,
            \"explanation\": \"why this fix works\",
            \"original_code\": \"exact lines to replace\",
            \"fixed_code\": \"replacement lines\"
          }
          If you cannot fix it safely, set can_fix to false."

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 2048,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }")

          # Extract response text
          FIX=$(echo "$RESPONSE" | jq -r '.content[0].text // "error"')
          echo "$FIX" > /tmp/claude_fix.json
          echo "fix_generated=true" >> $GITHUB_OUTPUT

      - name: DeepSeek validates fix
        id: deepseek_validate
        if: steps.claude_fix.outputs.fix_generated == 'true'
        run: |
          SOURCE=$(cat /tmp/source_code.txt)
          CLAUDE_FIX=$(cat /tmp/claude_fix.json)

          PROMPT="You are a senior code reviewer validating an AI-generated fix.

          ERROR: ${{ steps.parse.outputs.error_message }}
          FILE: ${{ steps.parse.outputs.error_file }}

          ORIGINAL SOURCE:
          $SOURCE

          PROPOSED FIX BY ANOTHER AI:
          $CLAUDE_FIX

          VALIDATE:
          1. Does this fix actually resolve the error?
          2. Does it introduce any new bugs or security issues?
          3. Is it the minimal change needed?

          Return EXACTLY this JSON:
          {
            \"approved\": true/false,
            \"reason\": \"explanation\",
            \"risk_level\": \"low/medium/high\"
          }"

          RESPONSE=$(curl -s https://api.deepseek.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DEEPSEEK_API_KEY }}" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"max_tokens\": 1024,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }")

          VALIDATION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "error"')
          echo "$VALIDATION" > /tmp/deepseek_validation.json

          # Check if approved
          APPROVED=$(echo "$VALIDATION" | jq -r '.approved // false')
          RISK=$(echo "$VALIDATION" | jq -r '.risk_level // "high"')
          echo "approved=$APPROVED" >> $GITHUB_OUTPUT
          echo "risk=$RISK" >> $GITHUB_OUTPUT

      - name: Apply fix and create PR
        if: steps.deepseek_validate.outputs.approved == 'true' && steps.deepseek_validate.outputs.risk != 'high'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="fix/k-doctor-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH"

          # Apply the fix using a Node.js script
          node -e "
            const fs = require('fs');
            const fix = JSON.parse(fs.readFileSync('/tmp/claude_fix.json', 'utf8'));
            if (!fix.can_fix || !fix.original_code || !fix.fixed_code) {
              console.log('Fix not applicable');
              process.exit(1);
            }
            const file = '${{ steps.parse.outputs.error_file }}';
            let content = fs.readFileSync(file, 'utf8');
            if (!content.includes(fix.original_code)) {
              console.log('Original code not found in file');
              process.exit(1);
            }
            content = content.replace(fix.original_code, fix.fixed_code);
            fs.writeFileSync(file, content);
            console.log('Fix applied successfully');
          "

          # Read explanations
          EXPLANATION=$(cat /tmp/claude_fix.json | jq -r '.explanation // "Auto-fix"')
          VALIDATION=$(cat /tmp/gpt_validation.json | jq -r '.reason // "Validated"')

          git config user.name "K-Doctor"
          git config user.email "k-doctor@kelionai.app"
          git add -A
          git commit -m "üîß K-Doctor: auto-fix for ${{ steps.parse.outputs.error_file }}"
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "üîß K-Doctor Auto-Fix: ${{ steps.parse.outputs.error_message }}" \
            --body "## K-Doctor Auto-Repair Report

          **Error:** \`${{ steps.parse.outputs.error_message }}\`
          **File:** \`${{ steps.parse.outputs.error_file }}\`
          **Sentry:** ${{ steps.parse.outputs.sentry_url }}

          ### Claude Fix
          $EXPLANATION

          ### GPT-4o Validation
          $VALIDATION

          ### Safety
          - Risk Level: ${{ steps.gpt_validate.outputs.risk }}
          - Dual-AI Consensus: ‚úÖ

          ---
          *This PR was generated automatically by K-Doctor.*
          *Tests must pass before auto-merge.*" \
            --label "k-doctor,auto-fix"

          # Enable auto-merge (requires tests to pass first)
          PR_NUMBER=$(gh pr list --head "$BRANCH" --json number -q '.[0].number')
          gh pr merge "$PR_NUMBER" --auto --squash || true

      - name: Report ‚Äî fix rejected
        if: steps.gpt_validate.outputs.approved != 'true' || steps.gpt_validate.outputs.risk == 'high'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CLAUDE_FIX=$(cat /tmp/claude_fix.json 2>/dev/null || echo "No fix generated")
          VALIDATION=$(cat /tmp/gpt_validation.json 2>/dev/null || echo "No validation")

          gh issue create \
            --title "‚ö†Ô∏è K-Doctor: Cannot auto-fix ‚Äî ${{ steps.parse.outputs.error_message }}" \
            --body "## Manual Fix Required

          **Error:** \`${{ steps.parse.outputs.error_message }}\`
          **File:** \`${{ steps.parse.outputs.error_file }}\`
          **Sentry:** ${{ steps.parse.outputs.sentry_url }}

          ### Why auto-fix was rejected:
          $VALIDATION

          ### Claude's proposed fix (rejected):
          \`\`\`json
          $CLAUDE_FIX
          \`\`\`

          ---
          *K-Doctor determined this fix is too risky for auto-deploy.*" \
            --label "k-doctor,needs-review"
