name: ðŸ”„ Sync All Secrets (Railway + Netlify â†’ GitHub)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

jobs:
  sync-from-railway:
    name: ðŸš‚ Railway â†’ GitHub Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      secrets: write
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Get Railway variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching Railway variables..."
          # Preia toate variabilele din Railway Ã®n format JSON
          VARS=$(railway variables --json 2>/dev/null || echo "{}")
          echo "Railway vars fetched"
          
          # ParseazÄƒ È™i adaugÄƒ fiecare variabilÄƒ ca GitHub Secret folosind gh CLI
          echo "$VARS" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ]; then
              echo "Setting GitHub secret: $key"
              echo "$value" | gh secret set "$key" --repo ${{ github.repository }}
            fi
          done

      - name: Summary
        run: echo "âœ… Railway secrets synced to GitHub!"

  sync-from-netlify:
    name: ðŸŒ Netlify â†’ GitHub Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      secrets: write
    steps:
      - name: Get Netlify env vars
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching Netlify env vars..."
          
          # Preia toate variabilele din Netlify API
          VARS=$(curl -s "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/env" \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}")
          
          echo "$VARS" | jq -r '.[] | "\(.key)=\(.values[0].value)"' | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ] && [ "$value" != "null" ]; then
              echo "Setting GitHub secret: $key"
              echo "$value" | gh secret set "$key" --repo ${{ github.repository }}
            fi
          done

      - name: Summary
        run: echo "âœ… Netlify secrets synced to GitHub!"

  sync-from-supabase:
    name: ðŸ—„ï¸ Supabase config â†’ GitHub Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Verify Supabase secrets exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking Supabase secrets..."
          # Supabase nu are CLI simplu, dar verificÄƒm cÄƒ secretele sunt setate
          echo "SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_KEY already in GitHub Secrets âœ…"

  report:
    name: ðŸ“‹ Sync Report
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [sync-from-railway, sync-from-netlify, sync-from-supabase]
    if: always()
    steps:
      - name: Print report
        run: |
          echo "## ðŸ”„ Secrets Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| SursÄƒ | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš‚ Railway | ${{ needs.sync-from-railway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Netlify | ${{ needs.sync-from-netlify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ Supabase | ${{ needs.sync-from-supabase.result }} |" >> $GITHUB_STEP_SUMMARY
