sync-all-secrets.yml
name: ðŸ”„ Sync All Secrets (Railway + Netlify â†’ GitHub)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

jobs:
  sync-from-railway:
    name: ðŸš‚ Railway â†’ GitHub Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Get Railway variables and sync to GitHub
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching Railway variables..."
          VARS=$(railway variables --json 2>/dev/null || echo "{}")
          echo "$VARS" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ]; then
              echo "Setting GitHub secret: $key"
              printf '%s' "$value" | gh secret set "$key" --repo adrianenc11-hue/kelionai-v2
            fi
          done
          echo "âœ… Railway â†’ GitHub sync done!"

  sync-from-netlify:
    name: ðŸŒ Netlify â†’ GitHub Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Get Netlify env vars and sync to GitHub
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching Netlify env vars..."
          VARS=$(curl -sf "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/env" \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" || echo "[]")
          echo "$VARS" | jq -r '.[] | select(.values[0].value != null) | "\(.key)=\(.values[0].value)"' | while IFS='=' read -r key value; do
            if [ -n "$key" ] && [ -n "$value" ] && [ "$value" != "null" ]; then
              echo "Setting GitHub secret: $key"
              printf '%s' "$value" | gh secret set "$key" --repo adrianenc11-hue/kelionai-v2
            fi
          done
          echo "âœ… Netlify â†’ GitHub sync done!"

  report:
    name: ðŸ“‹ Raport Sync
    runs-on: ubuntu-latest
    needs: [sync-from-railway, sync-from-netlify]
    if: always()
    steps:
      - name: Raport final
        run: |
          echo "## ðŸ”„ Sync Secrets Complet" >> $GITHUB_STEP_SUMMARY
          echo "| SursÄƒ | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš‚ Railway | ${{ needs.sync-from-railway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Netlify | ${{ needs.sync-from-netlify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "Rulat la: $(date)" >> $GITHUB_STEP_SUMMARY
